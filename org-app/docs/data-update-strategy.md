# データ更新戦略

## 概要

issendo.jp からの日本酒データを効率的に管理・更新するための戦略とツールの説明。

## 実装済み機能

### 1. 許可ドメイン設定
- `lib/ec/purchase-handler.ts` に `issendo.jp` を追加済み
- セキュリティを保ちながらissendo.jpへの安全な遷移が可能

### 2. 商品URL形式の修正
- 全商品のecUrlを `https://issendo.jp/?pid=PRODUCT_ID` 形式に統一
- 個別商品ページへの直接リンクが可能
- 現在は仮のPRODUCT_IDを使用（要手動更新）

### 3. 自動データ取得スクリプト
- `scripts/update-sake-data.js` を作成
- Puppeteerを使用したWebスクレイピング機能
- 商品データの自動取得・変換・差分チェック

## データ更新方法

### 手動更新（推奨）
```bash
# 1. スクレイピングスクリプト実行
npm run update-sake-data

# 2. 生成されたデータ確認
cat lib/data/sake-data-scraped.json

# 3. 手動でsake-data.tsに反映
# - 商品IDの正確な設定
# - 酒蔵情報の補完
# - 都道府県情報の追加
# - 味の特徴の調整
```

### 自動更新（将来実装）
- GitHub Actions による定期実行
- データ変更時の自動プルリクエスト作成
- 品質チェックとレビューフロー

## スクレイピングツールの機能

### 主要機能
1. **商品リスト取得**: issendo.jpから商品一覧を自動取得
2. **詳細情報抽出**: 個別商品ページから価格・説明文を取得
3. **データ変換**: sake-data.ts形式への自動変換
4. **差分チェック**: 既存データとの比較・新規商品検出
5. **レポート出力**: 取得結果の詳細レポート

### 設定可能項目
- 取得ページ数上限
- リクエスト間隔
- 出力ファイルパス
- ブラウザ設定

## データ品質の確保

### 自動変換の限界
スクレイピングツールが自動で設定する項目：
- 商品名、価格、説明文
- 基本的な日本酒タイプ（純米、吟醸等）
- 簡易的な特徴推定

### 手動補完が必要な項目
- **酒蔵名**: より正確な酒蔵情報
- **都道府県**: 生産地の特定
- **味の特徴**: sweetness、richness、acidity、aroma
- **商品タグ**: より詳細な特徴タグ
- **商品画像**: 高品質な画像URL
- **商品ID**: 実際のissendo.jp商品IDとの紐付け

## セキュリティ考慮事項

### スクレイピング時の注意
- リクエスト頻度の制限（1秒間隔）
- User-Agentの設定
- robots.txtの遵守
- サイト負荷への配慮

### データ利用時の注意
- 商品情報の著作権尊重
- 価格情報の免責事項
- 定期的なデータ検証

## 運用フロー

### 週次更新（推奨）
1. スクレイピングスクリプト実行
2. 新規商品の確認
3. 手動データ補完
4. 品質チェック
5. 本番データ更新

### 緊急更新
- 価格変更や商品廃番時の手動対応
- 個別商品データの修正

## 技術的依存関係

### 必要パッケージ
- `puppeteer`: Webスクレイピング
- `fs`: ファイル操作
- `path`: パス操作

### 開発環境要件
- Node.js 18以上
- Chrome/Chromiumブラウザ
- 十分なメモリ（推奨4GB以上）

## トラブルシューティング

### よくある問題
1. **スクレイピング失敗**: ネットワーク問題、サイト構造変更
2. **データ形式エラー**: 商品ページ構造の変更
3. **パフォーマンス問題**: 大量データ取得時のメモリ不足

### 解決方法
- リトライ機能の活用
- ログ出力の確認
- 取得件数の調整
- 手動データ確認

## 今後の改善予定

### 短期（1-2ヶ月）
- 商品IDの正確な紐付け実装
- エラーハンドリングの強化
- データ検証機能の追加

### 中期（3-6ヶ月）
- GitHub Actions連携
- 自動プルリクエスト作成
- 品質チェックの自動化

### 長期（6ヶ月以上）
- 他ECサイトとの連携
- リアルタイム価格更新
- 在庫状況の反映